# my_devops_project_2


***
## 1. Инструмент ipcalc

- Поднята виртуальная машина с названием - ws1.
- Установить ipcalc на ws1 с помощью команды `sudo apt install ipcalc`

![Вывод команды `sudo apt install ipcalc`](/screenshots/Part1/part1_1.PNG)

- Ввести команду в ws1 `ipcalc 192.167.38.54/13`

![Вывод команды `ipcalc 192.167.38.54/13`](screenshots/Part1/part1_2.PNG)

По рисунку можно определить:
Адрес сети - 192.160.0.0

### 1.1 Сети и маски

Для того, чтобы определить маску 255.255.255.0 в префиксном и двоичном виде, необходимо еще раз выполнить предыдущую команду, но без явного указания маски подсети. Ниже представлен вывод команды `ipcalc 192.167.38.54`

![Вывод команды `ipcalc 192.167.38.54`](screenshots/Part1/part1_3.PNG)

По рисунку
- Маска 255.255.255.0 в префиксном виде - 24;
- Маска 255.255.255.0 в двоичном виде - 11111111.11111111.11111111.00000000.

Для того, чтобы определить маску /15 в обычном и двоичном виде, необходимо еще раз выполнить предыдущую команду, но с явным указанием маски подсети. Ниже представлен вывод команды `ipcalc 192.167.38.54/15`

![Вывод команды `ipcalc 192.167.38.54/15`](screenshots/Part1/part1_4.PNG)

- Маска /15 в обычном виде - 255.254.0.0;
- маска /15 в двоичном виде - 11111111.1111111 0.00000000.00000000.

Для того, чтобы определить маску 11111111.11111111.11111111.11110000 в обычном виде, необходимо посчитать количество единиц. Префиксная форма определяется выполнением команды `ipclac 192.167.38.54/28`

![Вывод команды `ipcalc 192.167.38.54/28`](screenshots/Part1/part1_5.PNG)

- Маска 11111111.11111111.11111111.11110000 в обычном виде - 28;
- Маска 11111111.11111111.11111111.11110000 в префиксном виде - 255.255.255.240.

Для того, чтобы определить минимальный и максимальный хосты в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4, необходимо представить маску в десятичном виде. Т.к. /8 уже представлена в десятичном виде, можно выполнить команду `ipcalc 12.167.38.4/8` и определить хосты.

![Вывод команды `ipcalc 12.167.38.4/8`](screenshots/Part1/part1_6.PNG)

- Минимальный хост в сети 12.167.38.4/8 - 12.0.0.1;
- Максимальный хост в сети 12.167.38.4/8 - 12.255.255.254.

Для перевода маску 11111111.11111111.00000000.00000000 в обычный вид нужно посчитать количество единиц. После этого можно выполнить команду `ipcalc 12.167.38.4/16`

![Вывод команды `ipcalc 12.167.38.4/16`](screenshots/Part1/part1_7.PNG)

- Минимальный хост в сети 12.167.38.4/16 - 12.167.0.1;
- Максимальный хост в сети 12.167.38.4/16 - 12.167.255.254.

Для определения следующих хостов нужно выполнить команду `ipcalc 12.167.38.4/255.255.254.0`

![Вывод команды `ipcalc 12.167.38.4/255.255.254.0`](screenshots/Part1/part1_8.PNG)

- Минимальный хост в сети 12.167.38.4/255.255.254.0 - 12.167.38.1;
- Максимальный хост в сети 12.167.38.4/255.255.254.0 - 12.167.39.254.

Для определения следующих хостов нужно выполнить команду `ipcalc 12.167.38.4/4`

![Вывод команды`ipcalc 12.167.38.4/4`](screenshots/Part1/part1_9.PNG)

- Минимальный хост в сети 12.167.38.4/4 - 0.0.0.1;
- Максимальный хост в сети 12.167.38.4/4 - 15.255.255.254.

### 1.2 localhost

> __Localhost__ - это стандартное сетевое имя, которое используется для ссылки на локальный компьютер или локальный сервер в сети. Он обычно связан с IP-адресом 127.0.0.1, что означает, что он указывает на собственный сетевой интерфейс устройства.
> Localhost используется для обращения к веб-серверу, работающему на том же компьютере или сервере, на котором запущен браузер. Когда вы вводите "localhost" в адресной строке браузера, он перенаправляет запросы к серверу, работающему на вашем собственном компьютере.
> Localhost часто используется во время разработки веб-сайтов или веб-приложений. Вы можете запустить локальный веб-сервер на своем компьютере и просматривать сайт или тестировать приложение, необходимое вам без необходимости размещения его на удаленном сервере. Это удобно для отладки и разработки, поскольку вы можете вносить изменения и тестировать их мгновенно на своем локальном компьютере.
> Кроме того, localhost также используется для обращения к другим локальным службам, работающим на вашем компьютере, таким как базы данных или другие серверные приложения. Вы можете настроить эти службы на отклик на запросы, отправленные на localhost, чтобы обрабатывать данные или предоставлять другие функциональные возможности вашей локальной системы. Localhost имеет диапазон ip-адресов 127.0.0.1 — 127.255.255.254.
> Таким образом, localhost со следующими ip адресами может существовать: 127.0.0.2, 127.1.0.1, а с такими нет - 194.34.23.100, 128.0.0.1.

### 1.3. Диапазоны и сегменты сетей

- Частный IP-адрес существует в определенных диапазонах частных IP-адресов, зарезервированных Управлением по присвоению номеров в Интернете (IANA), и никогда не должен появляться в Интернете. Частные IP-адреса могут быть в следующих диапазонах:
  - Класс А: 10.0.0.0 – 10.255.255.255;
  - Класс B: 172.16.0.0 – 172.31.255.255;
  - Класс С: 192.168.0.0 – 192.168.255.255.
- Публичные IP-адреса могут быть в следующих диапазонах:
  - Класс A: 1.0.0.0 - 9.255.255.255, 11.0.0.0 - 126.255.255.255;
  - Класс В: 128.0.0.0 - 172.15.255.255, 172.32.0.0 - 191.255.255.255;
  - Класс С: 192.0.0.0 - 192.167.255.255, 192.169.0.0 - 223.255.255.255;
  - Класс D: 224.0.0.0 - 247.255.255.255.
  - Класс E: 248.0.0.0 - 255.255.255.254.
- Теперь расскажу о том, где используются данные классы:
  - Класс A: Адреса класса A предназначены для крупных сетей, таких как провайдеры интернета. Они используются для идентификации сетей, и их первый октет (от 1 до 126) определяет сеть, а остальные три октета - узлы в этой сети.
  - Класс B: Адреса класса B используются для средних сетей. Первые два октета (от 128 до 191) определяют сеть, а два последних октета - узлы в сети.
  - Класс C: Адреса класса C предназначены для небольших сетей. Первые три октета (от 192 до 223) определяют сеть, а последний октет - узлы в сети.
  - Класс D: Адреса класса D зарезервированы для многоадресной рассылки, то есть используются для групповых коммуникаций. Первый октет (от 224 до 239) указывает на класс D.
  - Класс E: Адреса класса E также зарезервированы и не используются в практических сетях. Первый октет (от 240 до 255) указывает на класс E.
- Из перечисленных ниже IP адресов можно использовать в качестве публичного следующие:
134.43.0.2, 172.0.2.1, 172.68.0.2, 192.169.168.1, 192.172.0.1;
- В качестве частных следующие: 10.0.0.45, 10.10.10.10, 172.20.250.4, 172.16.255.255, 192.168.4.2.
- Для определения какие IP адресы шлюза возможны у сети 10.10.0.0/18 необходимо выполнить команду `ipcalc 10.10.0.0/18`.

![Вывод команды `ipcalc 10.10.0.0/18`](screenshots/Part1/part1_10.PNG)

По рисунке видно, что у данной сети могут быть хосты (шлюзы) с адресами 10.10.0.1 - 10.10.63.254.
Учитывая вышеизложенное, возможными IP адресами данной сети (среди 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255) являются: 10.10.0.2, 10.10.10.10, 10.10.1.255.


***
## 2. Статическая маршрутизация между двумя машинами

- Подняты 2 виртуальные машины - __ws1__, __ws2__. Для того, чтобы сохранилось интернет соединение необходимо создать второй сетевой интерфейс. Для этого в Virtual box нужно настроить ОС в части __Сеть__, а именно выбрать __Адаптер 2__, тип подключения указать __Внутренняя сеть__.

![Вызов и вывод команды `ip a` на машине ws1](screenshots/Part2/part2_1.PNG)

![Вызов и вывод команды `ip a` на машине ws2](screenshots/Part2/part2_2.PNG)

- После описания сетевого интерфеса, файл "etc/netplan/00-installer-config.yaml" для машин ws1, ws2 имеет вид, представленный на рисунках ниже.

![Вывод команды `sudo vim /etc/netplan/00-installer-config.yaml` на ws1](screenshots/Part2/part2_3.PNG)

![Вывод команды `sudo vim /etc/netplan/00-installer-config.yaml` на ws2](screenshots/Part2/part2_4.PNG)

- Результат выполнения команды `sudo netplan apply` представлен на рисунках ниже для машин ws1, ws2 соответственно.

![Вызов и вывод команды `sudo netplan apply` на ws1](screenshots/Part2/part2_5.PNG)

![Вызов и вывод команды `sudo netplan apply` на ws2](screenshots/Part2/part2_6.PNG)

### 2.1. Добавление статического маршрута вручную

- Для добавления статического маршрута от одной машины до другой и обратно при помощи команды вида `ip r add` нужно на ws1 выполнить команду `sudo ip r add 172.24.116.8 dev enp0s8`, а на ws2 команду `sudo ip r add 192.168.100.10 dev enp0s8`.

![Вывод команды `sudo ip r add 172.24.116.8 dev enp0s8` на ws1](screenshots/Part2/part2_7.PNG)

![Вывод команды `sudo ip r add 192.168.100.10 dev enp0s8` на ws2](screenshots/Part2/part2_8.PNG)

- Для проверки соединения необходимо пропинговать соединение командой `ping 172.24.116.8`:

![Вывод команды `ping 172.24.116.8 -c 5` на ws1](screenshots/Part2/part2_9.PNG)

![Вывод команды `ping 192.168.100.10 -c 5` на ws2](screenshots/Part2/part2_10.PNG)

### 2.2. Добавление статического маршрута с сохранением

- Для того, чтобы добавить статический маршрут от одной машины до другой с помощью файла __etc/netplan/00-installer-config.yaml__ необходимо прописать маршрут. Содержимое данного файла для обеих машин представлен на рисунках ниже.

![Содержимое файла "etc/netplan/00-installer-config.yaml" машины ws1](screenshots/Part2/part2_11.PNG)

![Содержимое файла "etc/netplan/00-installer-config.yaml" машины ws2](screenshots/Part2/part2_12.PNG)

Для применения изменений необходимо выполнить команду `sudo netplan apply` для обеих машин.

- Пропинговать соединение между машинами. Результат приведен на рисунках ниже.

![Вывод команды `ping 172.24.116.8 -c 5`](screenshots/Part2/part2_13.PNG)

![Вывод команды `ping 192.168.100.10 -c 5`](screenshots/Part2/part2_14.PNG)


***
## 3. Утилита iperf3

### 3.1. Скорость соединения

- Для перевода скорости соединения из мегабит в секунду (Mbps) в мегабайт в секунду (MB/s) нужно учесть следующее:
1 Мегабит = 1/8 Мегабайта
Таким образом, чтобы перевести скорость из Mbps в MB/s, нужно разделить значение в Mbps на 8.
  - 8 Mbps = 1 MB/s;
- Для перевода скорости соединения из мегабайт в секунду (MB/s) в килобиты в секунду (Kbps) нужно учесть следующее:
1 Мегабайт = 8 Мегабит
Таким образом, чтобы перевести скорость из MB/s в Kbps, нужно умножить значение в MB/s на 8 и затем умножить на 1024 (поскольку в Kbps используется приставка "k", обозначающая тысячу).
  - 100 MB/s = 819 200 Kbps;
- Для перевода скорости соединения из гигабит в секунду (Gbps) в мегабит в секунду (Mbps) нужно учесть следующее:
1 Гигабит = 1024 Мегабит
Таким образом, чтобы перевести скорость из Gbps в Mbps, нужно умножить значение в Gbps на 1024.
  - 1 Gbps = 1024 Mbps.

### 3.2. Утилита iperf3

- Измерить скорость соединения между ws1 и ws2.
Для этого необходимо установить саму программу __iperf3__ на обеих машинах, для этого нужно выполнить команду `sudo apt install iperf3`. После этого нужно открыть порт (в данном случае 5201) для пакетов TCP, UDP в брандмауэре командами:
- `sudo firewall-cmd --permanent --add-port=5201/tcp`;
- `sudo firewall-cmd --permanent --add-port=5201/udp`;
- `sudo firewall-cmd --reload`.

![Вывод вышеперечисленных команд на ws1](screenshots/Part3/part3_1.PNG)

По окончании работы вышеупомянутых команд нужно запустить на сервере (пусть это будет ws1) команду `iperf3 -s`.
А на клиенте (пусть это будет ws2) нужно сделать запрос командой `iperf3 -c 192.168.100.10`. Ниже представлены выводы этих команд:

![Вывод команды `iperf3 -s` на сервере до запроса клиента на ws1](screenshots/Part3/part3_2.PNG)

![Вывод команды `iperf3 -c 192.168.100.10` на клиенте на ws2](screenshots/Part3/part3_3.PNG)

- 192.168.100.10 — адрес клиента;
- 172.24.116.8 — адрес сервера;
- ID — идентификатор запросов, нужен для ориентирования, если к серверу идет несколько обращений;
- Interval — промежуток времени в секундах, на протяжении которого выполнялась передача данных
- Transfer — сколько было передано данных за интервал времени;
- Bitrate — средняя скорость передачи данных за интервал времени;
- Retr — количество повторно отправленных TCP-сегментов;
- Cwnd — одновременно переданных данных.

![Вывод команды `iperf3 -s` на сервере после завершения запроса клиента на ws1](screenshots/Part3/part3_4.PNG)


***
## 4. Сетевой экран

### 4.1. Утилита iptables

- Создание файла __/etc/firewall.sh__, имитирующий фаерволл, на ws1 и ws2. 
- Содержимое вышеупомянутого файла после добавления правил приведено ниже.

![Содержимое файла /etc/firewall.sh машины ws1](screenshots/Part4/part4_1.PNG)

![Содержимое файла /etc/firewall.sh машины ws2](screenshots/Part4/part4_2.PNG)

- Запуск файла на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`

![Запуск команд `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` на ws1](screenshots/Part4/part4_3.PNG)

![Запуск команд `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` на ws2](screenshots/Part4/part4_4.PNG)

Стратегия, примененная для машины ws1 запрещает пинг, т.к. в начале написано запрещающее правило, а в конце разрешающее, а стратегия машины ws2 наоборот разрешает пинг, т.к. в начале написано разрещающее правило, в конце - запрещающее.

### 4.2. Утилита nmap

- Командой `ping` найти машину, которая не "пингуется", после чего утилитой __nmap__ показать, что хост машины запущен

![Результат команды `ping 192.168.100.10 -c 5`](screenshots/Part4/part4_5.PNG)

Как видно по рисунку машина ws1 с ip 192.168.100.10 не пингуется.

![Результат команды `nmap 192.168.100.10`](screenshots/Part4/part4_6.PNG)

По рисунку видно, что хост машины ws1 запущен

- Для сохранения дампов образов виртуальных машин при закрытии нужно выбрать __Сохранить состояние машины__.

![Сохранение результатов машины ws1](screenshots/Part4/part4_7.PNG)

![Сохранение результатов машины ws2](screenshots/Part4/part4_8.PNG)


***
## 5. Статическая маршрутизация сети

### 5.1. Настройка адресов машин

- Перед включением ws11, ws22 и ws21 настроить сеть, а именно включить "Адаптер2" и выбрать тип подключения "Внутренняя сеть".
- Перед включением r1 и r2 настроить сеть, а именно включить "Адаптер2", "Адаптер3" и выбрать тип подключения Внутренняя сеть.
- Так же необходимо проверить, чтобы MAC-адреса на рабочих станциях и роутерах отличались друг от друга.
- Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).
- Настроить конфигурации машин в "etc/netplan/00-installer-config.yaml" согласно сети, приведенной в задании.

На рисунках ниже приведены содержимые файла "etc/netplan/00-installer-config.yaml" для каждой машины и роутера.

![Содержимое файла "etc/netplan/00-installer-config.yaml" для ws11](screenshots/Part5/part5_1.PNG)

![Содержимое файла "etc/netplan/00-installer-config.yaml" для r1](screenshots/Part5/part5_2.PNG)

![Содержимое файла "etc/netplan/00-installer-config.yaml" для r2](screenshots/Part5/part5_3.PNG)

![Содержимое файла "etc/netplan/00-installer-config.yaml" для ws22](screenshots/Part5/part5_4.PNG)

![Содержимое файла "etc/netplan/00-installer-config.yaml" для ws21](screenshots/Part5/part5_5.PNG)

- Перезапустить сервис сети командой `sudo netplan apply`. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно. Также пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.

Для применения изменений необходимо выполнить команду `sudo netplan apply`. Ниже приведены выводы данной команды для каждой машины и роутера.

![Выводы команды `sudo netplan apply` для каждой машины и роутера](screenshots/Part5/part5_6.PNG)

Проверка введенных адресов можно проверить с помощью команды `ip -4 a`, т.е. "показать только IP-адреса версии 4 (IPv4)". Ниже приведены выводы данной команды.

![Вывод команды `ip -4 a` для ws11](screenshots/Part5/part5_7.PNG)

![Вывод команды `ip -4 a` для r1](screenshots/Part5/part5_8.PNG)

![Вывод команды `ip -4 a` для r2](screenshots/Part5/part5_9.PNG)

![Вывод команды `ip -4 a` для ws22](screenshots/Part5/part5_10.PNG)

![Вывод команды `ip -4 a` для ws21](screenshots/Part5/part5_11.PNG)

Для того, чтобы пропинговать ws22 с ws21 необходимо выполнить на ws22 команду `ping 10.20.0.10 -c 5` или на ws21 команду `ping 10.20.0.20 -c 5`. Результаты выполнения данных команд приведены ниже на рис. 5.12

![Выводы команд `ping 10.20.0.20 -c 5` и `ping 10.20.0.10 -c 5` на ws21 и ws22 соответственно](screenshots/Part5/part5_12.PNG)

Аналогично можно пропинговать r1 с ws11, для этого нужно выполнить на r1 команду `ping 10.10.0.2 -c 5` или на ws11 команду `ping 10.10.0.1 -c 5`. Результаты выполнения данных команд приведены ниже на рис. 5.13

![Выводы команд `ping 10.10.0.2 -c 5` и `ping 10.10.0.1 -c 5` на r1 и ws11 соответственно](screenshots/Part5/part5_13.PNG)

### 5.2. Включение переадресации IP-адресов

- Для включения переадресации IP, выполните команду на роутерах: `sysctl -w net.ipv4.ip_forward=1`

Вывод данной команды для роутеров приведен ниже.

![Вывод команды `sysctl -w net.ipv4.ip_forward=1` для роутера r1](screenshots/Part5/part5_14.PNG)

![Вывод команды `sysctl -w net.ipv4.ip_forward=1` для роутера r2](screenshots/Part5/part5_15.PNG)

- Откройте файл "/etc/sysctl.conf" и удалите символ "#" перед net.ipv4.ip_forward=1

Содержание файла "/etc/sysctl.conf" для обоих роутеров приведено ниже.

![Содержание файла "/etc/sysctl.conf" на r1](screenshots/Part5/part5_16.PNG)

![Содержание файла "/etc/sysctl.conf" на r2](screenshots/Part5/part5_17.PNG)

### 5.3. Установка маршрута по-умолчанию

- Для настройки маршрута по-умолчанию (шлюза) для рабочих станций нужно добавить строку "gateway4" в файле конфигураций. Ниже представлены содержимые данного файла каждой машины.

![Содержание файла "etc/netplan/00-installer-config.yaml" на ws11](screenshots/Part5/part5_18.PNG)

![Содержание файла "etc/netplan/00-installer-config.yaml" на ws22](screenshots/Part5/part5_19.PNG)

![Содержание файла "etc/netplan/00-installer-config.yaml" на ws21](screenshots/Part5/part5_20.PNG)

- Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации

![Вывод команды `ip r` на ws11](screenshots/Part5/part5_21.PNG)

![Вывод команды `ip r` на ws22](screenshots/Part5/part5_22.PNG)

![Вывод команды `ip r` на ws21](screenshots/Part5/part5_23.PNG)

- Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`

![Результат команд `ping 10.100.0.12 -c 5` на ws11 и `sudo tcpdump -tn -i enp0s8` на r2](screenshots/Part5/part5_24.PNG)

### 5.4. Добавление статических маршрутов

- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.

![Содержание изменённого файла "etc/netplan/00-installer-config.yaml" для r1](screenshots/Part5/part5_25.PNG)

![Содержание изменённого файла "etc/netplan/00-installer-config.yaml" для r2](screenshots/Part5/part5_26.PNG)

- Вызвать ip r и показать таблицы с маршрутами на обоих роутерах.

![Вывод команды `ip r` на r1](screenshots/Part5/part5_27.PNG)

![Вывод команды `ip r` на r2](screenshots/Part5/part5_28.PNG)

- Запустить команды на ws11: `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`.

![Вывод команд `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0` на ws11](screenshots/Part5/part5_29.PNG)

Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию, т.к. данный маршрут будет использоваться только тогда, когда не будет подходящих маршрутов (он имеет более низкий приоритет).

### 5.5. Построение списка маршрутизаторов

- Запустить на r1 команду дампа: `tcpdump -tnv -i enp0s8`.
- При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21

![Вывод команд `traceroute 10.20.0.10` на ws11 и `tcpdump -tnv -i enp0s8 -c 150` на r1](screenshots/Part5/part5_30.PNG)

- t - Не печатать временную метку в каждой строке дампа;
- n - Не конвертировать адреса (адреса узлов, номера портов и т. д.) в имена;
- v - Подробный вывод. Например, информация о времени жизни (TTL) и типе сервиса (ToS) в IP-пакете;
- i - Вывод информации, проходящую через определенный интерфейс;
- с - Указание количества пакетов, до которого нужно ввести захват.

> `traceroute` отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом.
> Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера).
> Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».
> Процесс повторяется до тех пор, пока пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

### 5.6. Использование протокола ICMP при маршрутизации

- Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i enp0s8 icmp`

![Вывод команды `tcpdump -n -i enp0s8 icmp` на r1](screenshots/Part5/part5_31.PNG)

- Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды: `ping -c 1 10.30.0.111`

![Вывод команды `ping -c 1 10.30.0.111` на ws11](screenshots/Part5/part5_32.PNG)


***
## 6. Динамическая настройка IP с помощью DHCP

- Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
  - Указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.

![Содержимое файла "/etc/dhcp/dhcpd.conf" на r2](screenshots/Part6/part6_1.PNG)

  - В файле resolv.conf прописать:

```bash
nameserver 8.8.8.8.
```

![Содержимое файла "/etc/resolv.conf" на r2](screenshots/Part6/part6_2.PNG)

- Перезагрузить службу DHCP командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.

Для динамической настройки IP с помощью DHCP неоходимо установить утилиту командой `sudo apt-get install isc-dhcp-server`.

![Вывод команды `systemctl restart isc-dhcp-server` на r2](screenshots/Part6/part6_3.PNG)

Для того, чтобы машинами ws22 и ws21 принимались динамические IP адреса необходимо прописать в файле "/etc/netplan/00-installer-config.yaml" `dhcp4: true` и удалить статически заданный IP адрес.

![Содержимое файла "etc/netplan/00-installer-config.yaml" на ws22](screenshots/Part6/part6_4.PNG)

![Содержимое файла "etc/netplan/00-installer-config.yaml" на ws21](screenshots/Part6/part6_5.PNG)

После этого необходимо применить изменения командой `sudo netplan apply` на обеих машинах.

![Выводы команд `ip a`, `ping 10.20.0.3 -c 3` на ws22](screenshots/Part6/part6_6.PNG)

![Выводы команд `ip a`, `ping 10.20.0.5 -c 3` на ws21](screenshots/Part6/part6_7.PNG)
- Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки:

```bash
macaddress: 10:10:10:10:10:BA
dhcp4: true
```

Для того, чтобы сохранился MAC адрес необходимо прописать его в виртуальной машине, предварительно выключив ее.

![Содержимое файла "etc/netplan/00-installer-config.yaml" на ws11](screenshots/Part6/part6_8.PNG)

- Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

![Содержимое файла "/etc/dhcp/dhcpd.conf" на r1](screenshots/Part6/part6_9.PNG)

![Содержимое файла "/etc/resolv.conf" на r1](screenshots/Part6/part6_10.PNG)

![Вывод команды `systemctl restart isc-dhcp-server` на r1](screenshots/Part6/part6_11.PNG)

![Вывод команды `systemctl restart isc-dhcp-server` на r1](screenshots/Part6/part6_12.PNG)

Об успешном результате проделанных операций можно убедиться проверив выданный IP адрес у ws11, а также пропинговав ее с роутером r1.

![Вывод команд `ip a` и `ping 10.10.0.1 -c 3` на ws11](screenshots/Part6/part6_13.PNG)

- Запросить с ws21 обновление ip адреса

Запрос обновления ip адреса осуществляется командой `sudo dhclient enp0s8`

![Вывод команды `ip a` на ws21 (до обновления)](screenshots/Part6/part6_14.PNG)

![Вывод команд `sudo dhclient enp0s8` и `ip a` на ws21 (после обновления)](screenshots/Part6/part6_15.PNG)

В пункте 6 использовались адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.

## 7. NAT

- В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным
Прежде всего нужно установить утилиту apache2 командой `sudo apt install apache2`.

![Содержание файла "/etc/apache2/ports.conf" на ws22](screenshots/Part7/part7_1.PNG)

![Содержание файла "/etc/apache2/ports.conf" на r1](screenshots/Part7/part7_2.PNG)

- Запустить веб-сервер Apache командой service apache2 start на ws22 и r1

![Вывод команды `service apache2 start` r1](screenshots/Part7/part7_3.PNG)

![Вывод команды `service apache2 start` ws22](screenshots/Part7/part7_4.PNG)

- Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) Удаление правил в таблице filter - iptables -F.
2) Удаление правил в таблице "NAT" - iptables -F -t nat.
3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP.

![Содержимое файла "/etc/firewall.sh" на r2](screenshots/Part7/part7_5.PNG)

- Запускать файл также, как в Части 4.

![Запуск файла "/etc/firewall.sh" на r2](screenshots/Part7/part7_6.PNG)

- Проверить соединение между ws22 и r1 командой `ping`.

![Вывод команд  `ip a` на ws22 и `ping 10.20.0.5 -c 5` на r1](screenshots/Part7/part7_7.PNG)

По рисунку видно, что ws22 с r1 не пингуется.

- Добавить в файл ещё одно правило:

4) Разрешить маршрутизацию всех пакетов протокола ICMP

![Содержимое файла "/etc/firewall.sh" на r2](screenshots/Part7/part7_8.PNG)

- Запускать файл также, как в Части 4.

![Запуск файла "/etc/firewall.sh" на r2](screenshots/Part7/part7_9.PNG)

- Проверить соединение между ws22 и r1 командой ping.

![Вывод команд  `ip a` на ws22 и `ping 10.20.0.5 -c 5` на r1](screenshots/Part7/part7_10.PNG)

По рисунку видно, что ws22 с r1 пингуется.

- Добавить в файл ещё два правила:

5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

![Содержимое файла "/etc/firewall.sh" на r2 после добавления SNAT](screenshots/Part7/part7_11.PNG)

- Командой `iptables -A FORWARD -s 10.20.0.0/26 -j ACCEPT` разрешили прохождение пакетов между сетевыми интерфейсами
из локальной сети 10.20.0.0/26;
- Командой `iptables -A FORWARD -d 10.20.0.0/26 -j ACCEPT` разрешили прохождение пакетов между сетевыми интерфейсами
в локальную сеть 10.20.0.0/26;
- Командой `iptables -t nat -A POSTROUTING -o enp0s9 -s 10.20.0.0/26 -j SNAT --to-source 10.100.0.12` включили трансляцию адресов сети 10.20.0.0/26 на адрес 10.100.0.12.

6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети

![Содержимое файла "/etc/firewall.sh" на r2 после добавления DNAT](screenshots/Part7/part7_12.PNG)

- Командой `iptables -t nat -A PREROUTING -i enp0s8 -p tcp --dport 8080 -j DNAT --to-destination 10.20.0.20:80` изменили адрес назначения всех пакетов пришедших на интерфейс enp0s8 по протоколу tcp с портом назначения TCP-сегмента 8080 на адрес внутреннего сервера 10.20.0.20 на порт 80.
- Запускать файл также, как в Части 4

![Запуск файла "/etc/firewall.sh" на r2](screenshots/Part7/part7_13.PNG)

- Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой: `telnet [адрес] [порт]`

![Вывод команды `telnet 10.100.0.11 80` на ws22](screenshots/Part7/part7_14.PNG)

- Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой telnet (обращаться по адресу r2 и порту 8080)

![Вывод команды `telnet 10.100.0.12 8080` на r1](screenshots/Part7/part7_15.PNG)


***
## 8. Дополнительно. Знакомство с SSH Tunnels

- Запустить на r2 фаервол с правилами из Части 7
- Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку `Listen 80` на `Listen localhost:80`)

![Содержимое файла "/etc/apache2/ports.conf" на ws22](screenshots/Part8/part8_1.PNG)

- Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21

![Вывод команды `service apache2 start` на ws22](screenshots/Part8/part8_2.PNG)

![Вывод команды `ssh -L 9999:localhost:80 10.20.0.20` на ws21 (Создание тулленя с ws21 на ws22)](screenshots/Part8/part8_3.PNG)

- Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.

![Вывод команды `ssh -R 8888:localhost:80 10.20.0.20` на ws11](screenshots/Part8/part8_4.PNG)

- Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду: `telnet 127.0.0.1 [локальный порт]`

![Вывод команды `telnet 127.0.0.1 9999` на ws21](screenshots/Part8/part8_5.PNG)

![Вывод команды `telnet 127.0.0.1 8888` на ws11](screenshots/Part8/part8_6.PNG)